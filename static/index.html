<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>TorrentDownloadManager</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
</head>
<body id="page1">

	<div class="Inputs">
		<form action="/" id="downloadForm">
			<input type="text" name="taskName" placeholder="Task Name">
			<input type="text" name="torrentURL" placeholder="Torrent URL">
			<input type="text" name="subtitleURL" placeholder="Subtitle URL">
			</br>
			</br>
			<input type="submit" value="Download!">
		</form>
		</br>
		<button onclick="reloadStorage()">Reload Storage...</button>
	</div>

	<div class="DownloadingList">
		<p>Downloading List:</p>
		<table id="DownloadingList">

		</table>
	</div>

	<div class="DownloadedList">
		<p>Downloaded List:</p>
		<ol id="DownloadedList">
		</ol>

		<table id="DownloadedList" style="width: 100%">

		</table>
	</div>

	<script>
	
		var host = 'localhost';
		var port = '8081';
		var called = false;
		doGetDownloadingList();
		doGetDownloadedList();
		listenForDownloading();
	
		// Attach a submit handler to the form
		$("#downloadForm")
				.submit(
						function(event) {

							// Stop form from submitting normally
							event.preventDefault();

							// Get some values from elements on the page:
							var $form = $(this), taskName = $form.find(
									"input[name='taskName']").val(), torrentURL = $form
									.find("input[name='torrentURL']").val(), subtitleURL = $form
									.find("input[name='subtitleURL']").val();

							var obj = {
								"taskName" : taskName,
								"torrentURL" : torrentURL,
								"subtitleURL" : subtitleURL
							};

							$.ajax({
								type : "POST",
								url : 'http://'+ host + ':' + port + '/downloadTorrent',
								contentType : 'application/json',
								async : false,
								data : JSON.stringify(obj),
								success : function() {
									doGetDownloadingList();
								}
							})

						});
		
		function listenForDownloading() {
			if(!$("#DownloadingList").children().length == 0){
				doGetDownloadingList();
			}
			setTimeout(listenForDownloading, 2000);
		}

		function doGetDownloadingList() {
			$.ajax({
				type : 'GET',
				url : 'http://'+ host + ':' + port + '/downloadingList',
				accept : 'application/json',
				success : function(data) {
					$("#DownloadingList").empty();
					for (var i = 0; i < data.length; i++) {
						var tr = document.createElement("tr");
						var td1 = document.createElement("td");
						td1.appendChild(document
								.createTextNode(data[i].downloadingProgress + ' - ' + data[i].taskName));
						var td2 = document.createElement("td");
						var stopAndRemoveButton = document.createElement("button");
						stopAndRemoveButton.setAttribute("id", "stopAndRemove");
						stopAndRemoveButton.setAttribute("taskName", data[i].taskName);
						stopAndRemoveButton.setAttribute("onclick", "stopAndRemove(this);");
						var stopStr = document.createTextNode("Stop and Remove");
						stopAndRemoveButton.appendChild(stopStr);
						td2.appendChild(stopAndRemoveButton);
						tr.append(td2);
						tr.append(td1);
						$("#DownloadingList").append(tr);
					}
					if(data.length != 0){
						// setTimeout(doGetDownloadingList, 2000);
					} 
				}
			});
		}

		var interval = 1000;
		function doGetDownloadedList() {
			$.ajax({
				type : 'GET',
				url : 'http://'+ host + ':' + port + '/downloadedList',
				accept : 'application/json',
				success : function(data) {
					$("#DownloadedList").empty();
					for (var i = 0; i < data.length; i++) {
						var tr = document.createElement("tr");
						var td = document.createElement("td");
						td.appendChild(document.createTextNode(data[i].taskName));
						var subTable = document.createElement("table");
						tr.appendChild(td);
						tr.appendChild(subTable);
						
						
						for(var file in data[i].files){
							var subTr = document.createElement("tr");
							
							var t1 = document.createElement("td");
							t1.appendChild(document.createTextNode(file));
							subTr.appendChild(t1);
							
							var t2 = document.createElement("td");
							t2.appendChild(document.createTextNode(data[i].files[file]));
							subTr.appendChild(t2);
							
							var deleteButton = document.createElement("button");
							deleteButton.setAttribute("id", "delete");
							deleteButton.setAttribute("filePath", file);
							deleteButton.setAttribute("taskName", data[i].taskName);
							deleteButton.setAttribute("onclick", "deleteFile(this);");
							var delStr = document.createTextNode("Delete");
							deleteButton.appendChild(delStr);
							subTr.appendChild(deleteButton);
							subTable.appendChild(subTr);
						}
						
						
						tr.appendChild(document.createElement("br"))
						$("#DownloadedList").append(tr);
					}
				}
			});
		}
		
		function reloadStorage() {
			$.ajax({
				type : 'GET',
				url : 'http://'+ host + ':' + port + '/reloadStorage',
				success : function(data) {
					doGetDownloadedList();
				}
			});
		}
		
		function deleteFile(el) {
			$.ajax({
				type : 'DELETE',
				url : 'http://'+ host + ':' + port + '/deleteFile?taskName=' + el.getAttribute("taskName")+ '&filePath=' + encodeURIComponent(el.getAttribute("filePath")),
				success : function(data) {
					doGetDownloadingList();
				}
			});
		}
		
		function stopAndRemove(el) {
			$.ajax({
				type : 'DELETE',
				url : 'http://'+ host + ':' + port + '/stopAndRemove?taskName=' + el.getAttribute("taskName"),
				success : function(data) {
					doGetDownloadingList();
				}
			});
		}
	</script>

</body>
</html>
